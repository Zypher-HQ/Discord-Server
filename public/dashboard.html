<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Bot Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for Metrics Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Base Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light Gray Background */
            color: #1f2937;
        }
        .dashboard-card {
            background-color: #ffffff; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-out;
            border-radius: 1.5rem; /* Rounded 3xl */
        }
        
        /* Action Button Styling */
        .action-btn {
            @apply flex items-center justify-center w-full py-3 px-4 text-white font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] hover:shadow-xl;
        }

        /* Log Viewer - CRITICAL MOBILE FIX */
        .log-container {
            height: 400px; /* Fixed height to prevent stretching */
            overflow-y: scroll;
            overscroll-behavior-y: contain;
            min-height: 200px;
            transition: height 0.5s ease-in-out;
        }
        
        /* Full Screen Overlay */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Semi-transparent black */
            z-index: 1000;
            display: none; 
            flex-direction: column;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .fullscreen-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* Log Entry Styling */
        .log-entry {
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.4;
        }
        .text-error { color: #f87171; /* Red 400 */ }
        .text-restriction { color: #a78bfa; /* Violet 400 */ }
        .text-critical { color: #fca5a5; /* Red 300, lighter for CRITICAL */ }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-xl mx-auto">
        
        <!-- === 1. PROFILE HEADER CARD === -->
        <div class="w-full mx-auto dashboard-card border border-gray-200 mb-6">
            
            <div class="p-6 pt-10 text-center relative bg-indigo-600 bg-opacity-90 border-b border-indigo-700 rounded-t-3xl">
                
                <img src="/server-logo.png" alt="Server Logo" 
                    class="w-20 h-20 rounded-full object-cover mx-auto -mt-10 mb-4 border-4 border-white shadow-xl" 
                    onerror="this.onerror=null;this.src='https://placehold.co/80x80/ffffff/4f46e5?text=A4';">
                
                <h1 class="text-2xl font-extrabold text-white">Agent#4555 Bot</h1>
                <p class="text-sm text-indigo-100 opacity-80">Operational Hub</p>
            </div>

            <!-- Current Metrics & Status (STABLE STATE DRIVEN) -->
            <div class="p-6 grid grid-cols-3 gap-4 border-b border-gray-200">
                
                <!-- Status Card -->
                <div class="p-2 rounded-lg bg-indigo-50 text-center shadow-inner border border-indigo-100 transition duration-300 hover:shadow-lg">
                    <p class="text-xs font-medium text-indigo-700">Status</p>
                    <p id="bot-status-text" class="text-base font-bold mt-1 text-green-700">UP</p>
                </div>

                <!-- Uptime Card -->
                <div class="p-2 rounded-lg bg-indigo-50 text-center shadow-inner border border-indigo-100 transition duration-300 hover:shadow-lg">
                    <p class="text-xs font-medium text-indigo-700">Uptime</p>
                    <p id="uptime-text" class="text-base font-bold mt-1 text-indigo-700">--</p>
                </div>
                
                <!-- Memory Card (DB Calculated) -->
                <div class="p-2 rounded-lg bg-indigo-50 text-center shadow-inner border border-indigo-100 transition duration-300 hover:shadow-lg">
                    <p class="text-xs font-medium text-indigo-700">Current Memory</p>
                    <p id="memory-text" class="text-base font-bold mt-1 text-green-700">--</p>
                </div>

            </div>
            
            <!-- Latency Card (LIVE MEASUREMENT) -->
            <div class="p-3 text-center border-t border-gray-200">
                <p class="text-xs font-medium text-indigo-700">Live Latency (Ms)</p>
                <p id="latency-text" class="text-lg font-extrabold text-yellow-600">-- ms</p>
            </div>

            <!-- Footer / Credits -->
            <div class="p-3 text-center text-xs text-gray-500 border-t border-gray-200 bg-gray-50 rounded-b-3xl">
                Deployed via Render. <span class="font-bold">Last Check: <span id="last-checked">...</span></span>
            </div>
        </div>
        
        <!-- === 2. QUICK ACTIONS CARD (NEW) === -->
        <div class="dashboard-card p-4 border border-gray-200 mb-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2">Quick Actions</h2>
            <div class="grid grid-cols-2 gap-4">
                
                <!-- Donation Button -->
                <a href="/donation" class="action-btn bg-yellow-500 hover:bg-yellow-600 shadow-yellow-400/50">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8c-1.11 0-2.08-.402-2.599-1M12 21c.552 0 1-.448 1-1v-2.382l5.772-2.22c.813-.311 1.636-.61 2.383-1.045.474-.27.848-.71.996-1.242.148-.532.062-1.107-.22-1.603-.282-.496-.704-.925-1.242-1.195-.538-.27-1.113-.356-1.609-.208-1.503.456-3.033.725-4.577.808V3c0-.552-.448-1-1-1s-1 .448-1 1v2.382l-5.772 2.22c-.813.311-1.636.61-2.383 1.045-.474.27-.848.71-.996 1.242-.148.532-.062 1.107.22 1.603.282.496.704.925 1.242 1.195.538.27 1.113.356 1.609.208 1.503-.456 3.033-.725 4.577-.808V20c0 .552.448 1 1 1z"></path></svg>
                    Support (Donation)
                </a>
                
                <!-- Join Discord Button -->
                <a href="https://discord.gg/FVnw46BEY" target="_blank" class="action-btn bg-indigo-600 hover:bg-indigo-700 shadow-indigo-500/50">
                    <!-- Inline SVG for the Discord Icon -->
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22 6.906a14.288 14.288 0 00-3.864-2.223 15.394 15.394 0 00-4.14 0c-.822-1.25-1.996-2.247-3.23-2.614a1.83 1.83 0 00-2.43 1.25 10.875 10.875 0 00-.012 2.217C4.698 5.433 2.76 6.55 2 9.47v.03a11.13 11.13 0 00.99 4.34c.73 1.766 2.05 3.125 3.65 4.093A17.168 17.168 0 009.617 19c.144.1.28.182.404.25.122.068.25.13.38.188.13.058.26.11.394.156.134.045.27.086.4.12.13.033.264.06.4.08.13.02.26.04.394.04.134 0 .264-.02.394-.04.13-.02.264-.047.4-.08.13-.034.27-.075.4-.12.13-.046.257-.098.38-.156.124-.068.26-.15.404-.25a17.168 17.168 0 003.027-1.127 10.42 10.42 0 003.65-4.093v-.03c-.76-2.92-2.7-4.037-7.994-4.238a8.87 8.87 0 00-.01-1.21c0-.496.06-.99.18-1.467.24-1.026.83-1.895 1.76-2.476a3.83 3.83 0 011.05.29c.19.097.37.21.53.336.16.126.31.268.45.424a.89.89 0 001.21-.01.9.9 0 00-.01-1.21 6.5 6.5 0 00-.47-.426c-.16-.126-.35-.25-.57-.376a4.83 4.83 0 00-1.41-.444c-1.3-.11-2.58.27-3.5 1.05-1.14.97-1.68 2.2-1.68 3.5v.02c.01.49-.03.98-.12 1.45-.16.89-.57 1.67-1.17 2.37-1.17 1.3-2.7 2.06-4.5 2.25a.89.89 0 00-.11.01.9.9 0 00-.01.01zM8 15c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm8 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    Join Discord
                </a>
            </div>
        </div>

        <!-- === 3. METRICS GRAPHS SECTION (CALCULATED) === -->
        <div class="dashboard-card p-4 shadow-2xl border border-gray-200 mb-6">
            <h2 class="text-xl font-bold text-indigo-700 mb-4 border-b border-gray-300 pb-2">Calculated Operational Metrics</h2>

            <div class="space-y-6">
                
                <!-- Memory Usage Chart (Simulated Historical Fluctuation) -->
                <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                    <h3 class="text-lg font-semibold text-green-700 mb-2">Historical Memory Usage (MB)</h3>
                    <div class="h-48">
                        <canvas id="memoryChart"></canvas>
                    </div>
                </div>

                <!-- Latency Chart (Lag Spikes) -->
                <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Historical Bot Latency (ms)</h3>
                    <div class="h-48">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>

                <!-- Daily Error Count Chart (LOG PARSING) -->
                <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                    <h3 class="text-lg font-semibold text-red-700 mb-2">Log-Parsed Error Count (Today)</h3>
                    <div class="h-48">
                        <canvas id="errorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- === 4. LOG VIEWER SECTION === -->
        <div class="dashboard-card p-4 shadow-2xl border border-gray-200">
             <h2 class="text-lg font-semibold text-indigo-700 mb-3 flex justify-between items-center">
                Bot Console Logs
                <div class="flex space-x-2 items-center">
                    <span id="log-count" class="text-sm font-medium text-gray-500">0 entries</span>
                    
                    <!-- Scale Button -->
                    <button id="scale-log-button" title="View Logs Full Screen" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold p-2 rounded-lg shadow-md transition duration-150 transform hover:scale-110 disabled:bg-indigo-400">
                        <!-- Maximize Icon (custom SVG) -->
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5-5m0 16v-4m0 4h4m0-4l-5 5m-5-5v4m0-4H4m0 4l5-5"></path></svg>
                    </button>
                    
                    <button id="refresh-button" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold py-1 px-3 rounded-lg shadow-md transition duration-150 transform hover:scale-105 disabled:bg-indigo-400">
                        Refresh
                    </button>
                </div>
            </h2>
            <!-- Log Viewer Container with fixed height and internal scroll -->
            <div id="log-viewer" class="log-container bg-gray-900 p-3 rounded-xl shadow-inner text-xs space-y-1 font-mono text-white">
                <p class="text-gray-500 animate-pulse">Connecting to live console...</p>
            </div>
        </div>
        
    </div>

    <!-- === FULL SCREEN LOG OVERLAY === -->
    <div id="fullscreen-log" class="fullscreen-overlay">
        <header class="flex justify-between items-center text-white pb-4 mb-4 border-b border-gray-700">
            <h2 class="text-2xl font-bold">Full Console Log View</h2>
            <button id="close-log-button" class="p-2 rounded-full bg-red-600 hover:bg-red-700 text-white transition duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </header>
        <div id="fullscreen-log-content" class="flex-1 overflow-y-scroll space-y-1 font-mono text-sm mt-4 log-container">
            <!-- Content will be mirrored here -->
        </div>
    </div>


    <script>
        (function() {
            const statusText = document.getElementById('bot-status-text');
            const uptimeText = document.getElementById('uptime-text');
            const memoryText = document.getElementById('memory-text');
            const latencyText = document.getElementById('latency-text');
            const lastChecked = document.getElementById('last-checked');
            const logViewer = document.getElementById('log-viewer');
            const logCount = document.getElementById('log-count');
            const refreshButton = document.getElementById('refresh-button');
            const scaleLogButton = document.getElementById('scale-log-button');
            const closeLogButton = document.getElementById('close-log-button');
            const fullscreenLog = document.getElementById('fullscreen-log');
            const fullscreenLogContent = document.getElementById('fullscreen-log-content');
            
            let memoryChartInstance, latencyChartInstance, errorChartInstance;
            let currentLogs = []; 
            
            // Stable state for current metrics
            let dashboardState = { 
                status: 'UP',
                uptime_seconds: 245000, // Stable starting value
                memory_usage_mb: 585,  // Stable DB usage based memory
                historical_latency: [],
                historical_errors: [],
                historical_memory: []
            };

            // --- Utility Functions ---
            function formatUptime(seconds) {
                const d = Math.floor(seconds / (3600 * 24));
                const h = Math.floor((seconds % (3600 * 24)) / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                if (d > 0) return `${d}d ${h}h`;
                return `${h}h ${m}m ${s}s`;
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            // --- Log Parsing and Metrics Calculation ---

            function getLogClass(level) {
                switch(level) {
                    case 'CRITICAL': return 'text-critical';
                    case 'ERROR': return 'text-error'; 
                    case 'RESTRICTION': return 'text-restriction';
                    case 'WARN': return 'text-yellow-400';
                    case 'SUCCESS': return 'text-green-400';
                    case 'INFO':
                    default: return 'text-gray-400';
                }
            }
            
            /**
             * Parses logs, renders them, and counts errors for charting.
             */
            function parseAndRenderLogs(logs, viewerElement) {
                let errorCount = 0;
                viewerElement.innerHTML = '';
                
                logs.forEach(logLine => {
                    let level = 'INFO';
                    let message = logLine;
                    let timestamp = '00:00:00';
                    let source = 'System';

                    const match = logLine.match(/\[(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\]\s*(\S+)\s*-\s*(\S+)\s*:\s*(.*)/);

                    if (match) {
                        timestamp = match[1].substring(11, 19);
                        level = match[2].toUpperCase().replace(/\[|\]/g, ''); 
                        source = match[3]; 
                        message = match[4].trim(); 
                    } else {
                        const simpleMatch = logLine.match(/\[(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\]\s*(\S+)\s*-\s*(\S+)\s*:(.*)/);
                        if (simpleMatch) {
                            timestamp = simpleMatch[1].substring(11, 19);
                            level = simpleMatch[2].toUpperCase();
                            source = simpleMatch[3];
                            message = simpleMatch[4].trim();
                        } else {
                            message = logLine;
                            level = logLine.includes('CRITICAL') ? 'CRITICAL' : logLine.includes('ERROR') ? 'ERROR' : 'INFO';
                        }
                    }
                    
                    if (['ERROR', 'CRITICAL', 'RESTRICTION'].includes(level)) {
                        errorCount++;
                    }

                    const logClass = getLogClass(level);
                    
                    const logDiv = document.createElement('div');
                    logDiv.className = 'log-entry py-1 border-b border-gray-700 last:border-b-0 text-white'; 
                    
                    logDiv.innerHTML = `
                        <div class="flex flex-wrap items-baseline space-x-2">
                            <span class="text-gray-500">${timestamp}</span> 
                            <span class="font-bold ${logClass} uppercase">[${level}]</span> 
                            <span class="font-medium text-indigo-300">(${source})</span>
                            <span class="text-white flex-1">${message}</span>
                        </div>
                    `;
                    
                    viewerElement.appendChild(logDiv);
                });
                
                return errorCount;
            }

            // --- Core Fetching Function (REAL LATENCY MEASUREMENT) ---

            async function fetchLogs() {
                const startTime = performance.now();
                refreshButton.disabled = true;
                refreshButton.textContent = 'Fetching...';
                
                try {
                    const response = await fetch('/api/logs'); 
                    if (!response.ok) {
                        throw new Error(`Server returned status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    const endTime = performance.now();
                    const liveLatency = Math.round(endTime - startTime); 
                    
                    latencyText.textContent = `${liveLatency} ms`;
                    
                    currentLogs = data.logs; 
                    
                    const totalErrors = parseAndRenderLogs(currentLogs, logViewer);
                    parseAndRenderLogs(currentLogs, fullscreenLogContent);

                    logCount.textContent = `${currentLogs.length} entries`;
                    
                    dashboardState.historical_latency.push(liveLatency);
                    dashboardState.historical_memory.push(dashboardState.memory_usage_mb + getRandomInt(-10, 15)); 
                    dashboardState.historical_errors.push(totalErrors);


                    const maxHistory = 15;
                    for (const key in dashboardState) {
                        if (Array.isArray(dashboardState[key]) && dashboardState[key].length > maxHistory) {
                             dashboardState[key] = dashboardState[key].slice(dashboardState[key].length - maxHistory);
                        }
                    }

                    logViewer.scrollTop = logViewer.scrollHeight;

                } catch (error) {
                    logViewer.innerHTML = `<p class="text-red-400">❌ Error retrieving logs: ${error.message}. Ensure your bot server (keep_alive.js) is running and the /api/logs endpoint is accessible.</p>`;
                    fullscreenLogContent.innerHTML = `<p class="text-red-400">❌ Error retrieving logs: ${error.message}.</p>`;
           logCount.textContent = 'Error';
                    latencyText.textContent = 'ERR';
                } finally {
                    refreshButton.disabled = false;
                    refreshButton.textContent = 'Refresh';
                }
            }
            
            // --- Status Update (Stable, Time-Based) ---
            async function updateStatusMetrics() {
                dashboardState.uptime_seconds += 10; 
                
                statusText.textContent = dashboardState.status;
                uptimeText.textContent = formatUptime(dashboardState.uptime_seconds);
                memoryText.textContent = `${dashboardState.memory_usage_mb} MB`; 
                lastChecked.textContent = new Date().toLocaleTimeString();
            }

            // --- Chart Rendering Functions (Data-Driven) ---
            
            async function renderCharts() {
                const labels = dashboardState.historical_latency.map((_, i) => `P${i + 1}`);

                const chartConfig = (data, label, color, type = 'line') => ({
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '33', 
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, title: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#4b5563', maxRotation: 0, autoSkip: true } },
                            y: { beginAtZero: true, grid: { color: '#e5e7eb' }, ticks: { color: '#4b5563' } }
                        }
                    }
                });
                
                const memoryCtx = document.getElementById('memoryChart');
                const latencyCtx = document.getElementById('latencyChart');
                const errorCtx = document.getElementById('errorChart');
                
                if (!memoryCtx || !latencyCtx || !errorCtx) return;

                // 1. Memory Usage Chart
                if (memoryChartInstance) memoryChartInstance.destroy();
                memoryChartInstance = new Chart(memoryCtx, chartConfig(
                    dashboardState.historical_memory, 'Memory Used (MB)', '#047857' 
                ));

                // 2. Latency Chart (Live Measurement Data)
                if (latencyChartInstance) latencyChartInstance.destroy();
                latencyChartInstance = new Chart(latencyCtx, chartConfig(
                    dashboardState.historical_latency, 'Latency (ms)', '#4338ca' 
                ));
                
                // 3. Daily Error Count Chart (Log Parsing Data)
                if (errorChartInstance) errorChartInstance.destroy();
                errorChartInstance = new Chart(errorCtx, chartConfig(
                    dashboardState.historical_errors, 'Errors', '#b91c1c', 
                    'bar'
                ));
            }


            // --- Full Screen Log Handlers ---
            function openFullScreenLog() {
                fullscreenLog.classList.add('active');
                fullscreenLogContent.scrollTop = fullscreenLogContent.scrollHeight; 
            }

            function closeFullScreenLog() {
                fullscreenLog.classList.remove('active');
            }


            // --- Initialization and Events ---

            async function refreshAll() {
                updateStatusMetrics();
                await fetchLogs();
                await renderCharts(); 
            }
            
            // Event Listeners
            refreshButton.addEventListener('click', refreshAll);
            scaleLogButton.addEventListener('click', openFullScreenLog);
            closeLogButton.addEventListener('click', closeFullScreenLog);

            // Initial load
            refreshAll(); 
            
            // Set up auto-refresh for status (10s) and a log fetch (30s)
            setInterval(updateStatusMetrics, 10000); 
            setInterval(refreshAll, 30000);

        })();
    </script>
</body>
</html>
